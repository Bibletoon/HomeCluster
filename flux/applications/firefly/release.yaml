apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
    name: firefly
    namespace: firefly
spec:
    interval: 1h
    chart:
        spec:
            chart: firefly-iii
            version: '1.9.2'
            sourceRef:
                kind: HelmRepository
                name: firefly
                namespace: firefly
            interval: 1h
    values:
      persistence:
        enabled: true
        storageClass: longhorn
        storage: 1Gi
      config:
        env:
          AUTHENTICATION_GUARD: remote_user_guard
          AUTHENTICATION_GUARD_HEADER: HTTP_OIDC_EMAIL
          DB_CONNECTION: pgsql
          TZ: "Europe/Moscow"
      secrets:
        env:
          APP_PASSWORD: ''
      ingress:
        enabled: true
        annotations:
          traefik.ingress.kubernetes.io/router.middlewares: traefik-oidc@kubernetescrd
        className: traefik
        hosts:
          - firefly.bibletoon.xyz
    valuesFrom:
        - kind: Secret
          targetPath: secrets.env.DB_PASSWORD
          name: firefly-postgres-app
          valuesKey: password
        - kind: Secret
          targetPath: config.env.DB_HOST
          name: firefly-postgres-app
          valuesKey: host
        - kind: Secret
          targetPath: config.env.DB_DATABASE
          name: firefly-postgres-app
          valuesKey: dbname
        - kind: Secret
          targetPath: config.env.DB_USERNAME
          name: firefly-postgres-app
          valuesKey: user
        - kind: Secret
          targetPath: config.env.DB_PORT
          name: firefly-postgres-app
          valuesKey: port
